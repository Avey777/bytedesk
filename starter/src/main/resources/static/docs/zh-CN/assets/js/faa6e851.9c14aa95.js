"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3852],{19971:(n,e,s)=>{s.d(e,{R:()=>o,x:()=>c});var t=s(30758);const i={},r=t.createContext(i);function o(n){const e=t.useContext(r);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:o(n.components),t.createElement(r.Provider,{value:e},n.children)}},81393:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"development/stomp","title":"\u8bbf\u5ba2\u7aef\u957f\u8fde\u63a5","description":"\u8bbf\u5ba2\u7aef\u57fa\u4e8eSTOMP\u534f\u8bae\u5b9e\u73b0\u957f\u8fde\u63a5\uff0c\u7528\u4e8e\u4e0e\u670d\u52a1\u5668\u5efa\u7acb\u6301\u4e45\u7684\u8fde\u63a5\uff0c\u652f\u6301\u5b9e\u65f6\u6d88\u606f\u6536\u53d1\u3002","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/development/stomp.md","sourceDirName":"development","slug":"/development/stomp","permalink":"/docs/zh-CN/docs/development/stomp","draft":false,"unlisted":false,"editUrl":"https://github.com/bytedesk/bytedesk-docs/blob/main/i18n/zh-CN/docusaurus-plugin-content-docs/current/development/stomp.md","tags":[],"version":"current","lastUpdatedBy":"jack ning","lastUpdatedAt":1754536403000,"sidebarPosition":33,"frontMatter":{"sidebar_label":"\u8bbf\u5ba2\u7aef\u957f\u8fde\u63a5","sidebar_position":33},"sidebar":"tutorialSidebar","previous":{"title":"\u5ba2\u670d\u7aef\u957f\u8fde\u63a5","permalink":"/docs/zh-CN/docs/development/mqtt"},"next":{"title":"\u5ba2\u670d\u52a9\u624b","permalink":"/docs/zh-CN/docs/development/assistant"}}');var i=s(86070),r=s(19971);const o={sidebar_label:"\u8bbf\u5ba2\u7aef\u957f\u8fde\u63a5",sidebar_position:33},c="\u8bbf\u5ba2\u7aef\u957f\u8fde\u63a5",a={},l=[{value:"\u534f\u8bae\u8bf4\u660e",id:"\u534f\u8bae\u8bf4\u660e",level:2},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:2},{value:"1. \u5b89\u88c5\u4f9d\u8d56",id:"1-\u5b89\u88c5\u4f9d\u8d56",level:3},{value:"2. \u5efa\u7acb\u8fde\u63a5",id:"2-\u5efa\u7acb\u8fde\u63a5",level:3},{value:"STOMP\u670d\u52a1\u5668\u8fde\u63a5\u8bf4\u660e",id:"stomp\u670d\u52a1\u5668\u8fde\u63a5\u8bf4\u660e",level:4},{value:"3. \u6dfb\u52a0\u4e8b\u4ef6\u76d1\u542c",id:"3-\u6dfb\u52a0\u4e8b\u4ef6\u76d1\u542c",level:3},{value:"\u6838\u5fc3\u529f\u80fd",id:"\u6838\u5fc3\u529f\u80fd",level:2},{value:"\u8ba2\u9605\u6d88\u606f\u4e3b\u9898",id:"\u8ba2\u9605\u6d88\u606f\u4e3b\u9898",level:3},{value:"\u53d1\u9001\u6d88\u606f",id:"\u53d1\u9001\u6d88\u606f",level:3},{value:"\u5904\u7406\u63a5\u6536\u6d88\u606f",id:"\u5904\u7406\u63a5\u6536\u6d88\u606f",level:3},{value:"\u7279\u6b8a\u6d88\u606f\u7c7b\u578b\u5904\u7406",id:"\u7279\u6b8a\u6d88\u606f\u7c7b\u578b\u5904\u7406",level:3},{value:"1. \u53d1\u9001\u7559\u8a00\u6d88\u606f",id:"1-\u53d1\u9001\u7559\u8a00\u6d88\u606f",level:4},{value:"2. \u53d1\u9001\u8bc4\u4ef7\u6d88\u606f",id:"2-\u53d1\u9001\u8bc4\u4ef7\u6d88\u606f",level:4},{value:"3. \u53d1\u9001\u6d88\u606f\u64a4\u56de",id:"3-\u53d1\u9001\u6d88\u606f\u64a4\u56de",level:4},{value:"\u6d88\u606f\u56de\u6267\u5904\u7406",id:"\u6d88\u606f\u56de\u6267\u5904\u7406",level:3},{value:"\u8fde\u63a5\u7ba1\u7406",id:"\u8fde\u63a5\u7ba1\u7406",level:2},{value:"\u53d6\u6d88\u8ba2\u9605",id:"\u53d6\u6d88\u8ba2\u9605",level:3},{value:"\u65ad\u5f00\u8fde\u63a5",id:"\u65ad\u5f00\u8fde\u63a5",level:3},{value:"HTTP\u964d\u7ea7\u5904\u7406",id:"http\u964d\u7ea7\u5904\u7406",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u8fde\u63a5\u7ba1\u7406",id:"1-\u8fde\u63a5\u7ba1\u7406",level:3},{value:"2. \u6d88\u606f\u5904\u7406",id:"2-\u6d88\u606f\u5904\u7406",level:3},{value:"3. \u6027\u80fd\u4f18\u5316",id:"3-\u6027\u80fd\u4f18\u5316",level:3},{value:"4. \u7528\u6237\u4f53\u9a8c",id:"4-\u7528\u6237\u4f53\u9a8c",level:3},{value:"\u5b8c\u6574\u793a\u4f8b",id:"\u5b8c\u6574\u793a\u4f8b",level:2},{value:"\u53c2\u8003\u8fde\u63a5",id:"\u53c2\u8003\u8fde\u63a5",level:2}];function d(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"\u8bbf\u5ba2\u7aef\u957f\u8fde\u63a5",children:"\u8bbf\u5ba2\u7aef\u957f\u8fde\u63a5"})}),"\n",(0,i.jsx)(e.p,{children:"\u8bbf\u5ba2\u7aef\u57fa\u4e8eSTOMP\u534f\u8bae\u5b9e\u73b0\u957f\u8fde\u63a5\uff0c\u7528\u4e8e\u4e0e\u670d\u52a1\u5668\u5efa\u7acb\u6301\u4e45\u7684\u8fde\u63a5\uff0c\u652f\u6301\u5b9e\u65f6\u6d88\u606f\u6536\u53d1\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u534f\u8bae\u8bf4\u660e",children:"\u534f\u8bae\u8bf4\u660e"}),"\n",(0,i.jsx)(e.p,{children:"STOMP (Simple Text Oriented Messaging Protocol) \u662f\u4e00\u79cd\u7b80\u5355\u7684\u9762\u5411\u6587\u672c\u7684\u6d88\u606f\u4f20\u8f93\u534f\u8bae\uff0c\u57fa\u4e8eWebSocket\u5b9e\u73b0\u3002\u5fae\u8bed\u4f7f\u7528STOMP\u534f\u8bae\u4e3a\u8bbf\u5ba2\u7aef\u63d0\u4f9b\u5b9e\u65f6\u6d88\u606f\u6536\u53d1\u529f\u80fd\uff0c\u786e\u4fdd\u8bbf\u5ba2\u4e0e\u5ba2\u670d\u4e4b\u95f4\u7684\u53cc\u5411\u901a\u4fe1\u3002"}),"\n",(0,i.jsxs)(e.admonition,{title:"\u4f7f\u7528\u573a\u666f\u8bf4\u660e",type:"info",children:[(0,i.jsxs)(e.p,{children:["STOMP\u957f\u8fde\u63a5\u4e3b\u8981\u7528\u4e8e",(0,i.jsx)(e.strong,{children:"\u8bbf\u5ba2\u7aef\u6536\u53d1\u6d88\u606f"}),"\u7684\u573a\u666f\u3002\u5f53\u7f51\u7ad9\u8bbf\u5ba2\u9700\u8981\u4e0e\u5ba2\u670d\u8fdb\u884c\u5b9e\u65f6\u5bf9\u8bdd\u65f6\uff0c\u901a\u8fc7STOMP\u534f\u8bae\u53ef\u4ee5\u5b9e\u73b0\uff1a"]}),(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5b9e\u65f6\u6d88\u606f\u63a5\u6536"}),"\uff1a\u8bbf\u5ba2\u53ef\u4ee5\u7acb\u5373\u63a5\u6536\u5230\u5ba2\u670d\u56de\u590d\u7684\u6d88\u606f"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u53cc\u5411\u901a\u4fe1\u652f\u6301"}),"\uff1a\u8bbf\u5ba2\u53ef\u4ee5\u53d1\u9001\u6d88\u606f\u7ed9\u5ba2\u670d\uff0c\u5e76\u63a5\u6536\u5ba2\u670d\u56de\u590d"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6d88\u606f\u72b6\u6001\u7ba1\u7406"}),"\uff1a\u652f\u6301\u6d88\u606f\u9001\u8fbe\u56de\u6267\u3001\u5df2\u8bfb\u56de\u6267\u7b49\u72b6\u6001\u66f4\u65b0"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u591a\u79cd\u6d88\u606f\u7c7b\u578b"}),"\uff1a\u652f\u6301\u6587\u672c\u3001\u56fe\u7247\u3001\u6587\u4ef6\u3001\u8bc4\u4ef7\u3001\u7559\u8a00\u7b49\u591a\u79cd\u6d88\u606f\u7c7b\u578b"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u81ea\u52a8\u91cd\u8fde\u673a\u5236"}),"\uff1a\u8fde\u63a5\u65ad\u5f00\u65f6\u81ea\u52a8\u91cd\u8fde\uff0c\u4fdd\u8bc1\u670d\u52a1\u7a33\u5b9a\u6027"]}),"\n"]}),(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u5178\u578b\u6d41\u7a0b\uff1a"})}),(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"\u8bbf\u5ba2\u7aef\u5efa\u7acbSTOMP\u8fde\u63a5\u5e76\u8ba2\u9605\u6d88\u606f\u4e3b\u9898"}),"\n",(0,i.jsx)(e.li,{children:"\u8bbf\u5ba2\u53d1\u9001\u6d88\u606f\u5230\u670d\u52a1\u5668"}),"\n",(0,i.jsx)(e.li,{children:"\u670d\u52a1\u5668\u5c06\u6d88\u606f\u63a8\u9001\u7ed9\u5ba2\u670d\u7aef"}),"\n",(0,i.jsx)(e.li,{children:"\u5ba2\u670d\u56de\u590d\u6d88\u606f\uff0c\u670d\u52a1\u5668\u63a8\u9001\u7ed9\u8bbf\u5ba2\u7aef"}),"\n",(0,i.jsx)(e.li,{children:"\u8bbf\u5ba2\u7aef\u5b9e\u65f6\u63a5\u6536\u5e76\u663e\u793a\u6d88\u606f"}),"\n"]})]}),"\n",(0,i.jsx)(e.h2,{id:"\u5feb\u901f\u5f00\u59cb",children:"\u5feb\u901f\u5f00\u59cb"}),"\n",(0,i.jsx)(e.h3,{id:"1-\u5b89\u88c5\u4f9d\u8d56",children:"1. \u5b89\u88c5\u4f9d\u8d56"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"npm install @stomp/stompjs\n"})}),"\n",(0,i.jsx)(e.h3,{id:"2-\u5efa\u7acb\u8fde\u63a5",children:"2. \u5efa\u7acb\u8fde\u63a5"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'import * as StompJs from "@stomp/stompjs";\n\n// \u5168\u5c40STOMP\u5ba2\u6237\u7aef\u53d8\u91cf\nlet stompClient: StompJs.Client;\nlet transformedTopic: string;\nlet subscribedTopics: string[] = [];\n\n// \u8fde\u63a5\u53c2\u6570\u7c7b\u578b\u5b9a\u4e49\ntype StompConnectProps = {\n  username?: string;    // \u7528\u6237\u540d\uff08\u53ef\u9009\uff09\n  password?: string;    // \u5bc6\u7801\uff08\u53ef\u9009\uff09\n  topic: string;        // \u8ba2\u9605\u4e3b\u9898\n  orgUid: string;       // \u7ec4\u7ec7\u552f\u4e00\u6807\u8bc6\n};\n\n// \u5efa\u7acbSTOMP\u8fde\u63a5\nexport const stompConnect = ({ username, topic, orgUid }: StompConnectProps) => {\n  console.log("STOMP\u8fde\u63a5\u53c2\u6570:", { username, topic, orgUid });\n  subscribedTopics = [];\n\n  // \u521b\u5efaSTOMP\u5ba2\u6237\u7aef\u5b9e\u4f8b\n  stompClient = new StompJs.Client({\n    brokerURL: getStompWsUrl(), // WebSocket\u670d\u52a1\u5668\u5730\u5740\n    connectHeaders: {\n      login: username || "",\n      // \u53ef\u4ee5\u6dfb\u52a0\u5176\u4ed6\u8ba4\u8bc1\u5934\u4fe1\u606f\n    },\n    // \u5fc3\u8df3\u914d\u7f6e - \u4fdd\u6301\u8fde\u63a5\u6d3b\u8dc3\n    heartbeatIncoming: 10 * 1000, // 10\u79d2\uff0c\u4e0e\u670d\u52a1\u5668\u4fdd\u6301\u4e00\u81f4\n    heartbeatOutgoing: 10 * 1000, // 10\u79d2\uff0c\u4e0e\u670d\u52a1\u5668\u4fdd\u6301\u4e00\u81f4\n    // \u8c03\u8bd5\u4fe1\u606f\u8f93\u51fa\n    debug: function (str) {\n      if (process.env.NODE_ENV === \'development\') {\n        console.log("STOMP\u8c03\u8bd5:", str);\n      }\n    },\n  });\n\n  return stompClient;\n};\n'})}),"\n",(0,i.jsx)(e.h4,{id:"stomp\u670d\u52a1\u5668\u8fde\u63a5\u8bf4\u660e",children:"STOMP\u670d\u52a1\u5668\u8fde\u63a5\u8bf4\u660e"}),"\n",(0,i.jsx)(e.p,{children:"\u5fae\u8bed\u652f\u6301WebSocket\u534f\u8bae\u8fde\u63a5STOMP\u670d\u52a1\u5668\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'// \u83b7\u53d6STOMP WebSocket\u8fde\u63a5\u5730\u5740\nconst getStompWsUrl = () => {\n  const isDevelopment = process.env.NODE_ENV === \'development\';\n  \n  if (isDevelopment) {\n    // \u5f00\u53d1\u73af\u5883\n    return "ws://127.0.0.1:9003/stomp";\n  } else {\n    // \u751f\u4ea7\u73af\u5883\n    return "wss://api.weiyuai.cn/stomp";\n  }\n};\n\n// \u4f7f\u7528\u793a\u4f8b\nconst client = new StompJs.Client({\n  brokerURL: getStompWsUrl(),\n  // \u5176\u4ed6\u914d\u7f6e...\n});\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u8fde\u63a5\u5730\u5740\u683c\u5f0f\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-text",children:"ws://127.0.0.1:9003/stomp     # \u672c\u5730\u5f00\u53d1\u73af\u5883\nwss://api.weiyuai.cn/stomp    # \u751f\u4ea7\u73af\u5883\n"})}),"\n",(0,i.jsx)(e.h3,{id:"3-\u6dfb\u52a0\u4e8b\u4ef6\u76d1\u542c",children:"3. \u6dfb\u52a0\u4e8b\u4ef6\u76d1\u542c"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'// \u8fde\u63a5\u6210\u529f\u4e8b\u4ef6\nstompClient.onConnect = function (frame) {\n  console.log("STOMP\u8fde\u63a5\u6210\u529f:", frame);\n  \n  // \u7b49\u5f85\u8fde\u63a5\u5b8c\u5168\u5efa\u7acb\u540e\u518d\u8ba2\u9605\n  setTimeout(() => {\n    if (stompClient && stompClient.connected) {\n      stompSubscribe({ topic, orgUid });\n    } else {\n      console.error("STOMP\u8fde\u63a5\u5c1a\u672a\u5b8c\u5168\u5efa\u7acb");\n    }\n  }, 500); // \u6dfb\u52a0500\u6beb\u79d2\u5ef6\u65f6\uff0c\u786e\u4fdd\u8fde\u63a5\u5df2\u5b8c\u6210\u5efa\u7acb\n};\n\n// \u8fde\u63a5\u65ad\u5f00\u4e8b\u4ef6\nstompClient.onDisconnect = function (frame) {\n  console.log("STOMP\u8fde\u63a5\u65ad\u5f00:", frame);\n  subscribedTopics = [];\n};\n\n// WebSocket\u5173\u95ed\u4e8b\u4ef6\nstompClient.onWebSocketClose = (event) => {\n  console.log("WebSocket\u8fde\u63a5\u5173\u95ed:", event);\n  subscribedTopics = [];\n};\n\n// WebSocket\u9519\u8bef\u4e8b\u4ef6\nstompClient.onWebSocketError = (error) => {\n  console.error("WebSocket\u8fde\u63a5\u9519\u8bef:", error);\n  subscribedTopics = [];\n};\n\n// STOMP\u534f\u8bae\u9519\u8bef\u4e8b\u4ef6\nstompClient.onStompError = function (frame) {\n  console.error("STOMP\u534f\u8bae\u9519\u8bef:", frame.headers["message"]);\n  console.error("\u9519\u8bef\u8be6\u60c5:", frame.body);\n  subscribedTopics = [];\n};\n\n// \u6fc0\u6d3b\u8fde\u63a5\nstompClient.activate();\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u6838\u5fc3\u529f\u80fd",children:"\u6838\u5fc3\u529f\u80fd"}),"\n",(0,i.jsx)(e.h3,{id:"\u8ba2\u9605\u6d88\u606f\u4e3b\u9898",children:"\u8ba2\u9605\u6d88\u606f\u4e3b\u9898"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'// \u8ba2\u9605\u53c2\u6570\u7c7b\u578b\u5b9a\u4e49\ntype StompSubscribeProps = {\n  topic: string;    // \u8ba2\u9605\u4e3b\u9898\n  orgUid: string;   // \u7ec4\u7ec7\u6807\u8bc6\n};\n\n// \u8ba2\u9605\u6d88\u606f\u4e3b\u9898\nexport const stompSubscribe = ({ topic, orgUid }: StompSubscribeProps) => {\n  // \u8f6c\u6362\u4e3b\u9898\u683c\u5f0f\uff1a\u5c06/\u66ff\u6362\u4e3a.\n  transformedTopic = topic.replace(/\\//g, ".");\n  \n  // \u68c0\u67e5\u8fde\u63a5\u72b6\u6001\n  if (stompClient == null || !stompClient.connected) {\n    console.log("STOMP\u5ba2\u6237\u7aef\u672a\u8fde\u63a5");\n    return;\n  }\n  \n  // \u9632\u6b62\u91cd\u590d\u8ba2\u9605\n  if (subscribedTopics.includes(transformedTopic)) {\n    console.log("\u4e3b\u9898\u5df2\u8ba2\u9605:", transformedTopic);\n    return;\n  }\n  \n  subscribedTopics.push(transformedTopic);\n  console.log("\u8ba2\u9605\u4e3b\u9898:", transformedTopic);\n  \n  try {\n    stompClient.subscribe(\n      "/topic/" + transformedTopic,\n      (message) => {\n        if (message.body) {\n          const messageObject: MessageResponse = JSON.parse(message.body);\n          handleReceivedMessage(messageObject, orgUid);\n        }\n        // \u786e\u8ba4\u6d88\u606f\u5df2\u5904\u7406\n        message.ack();\n      },\n      { ack: "client" } // \u5ba2\u6237\u7aef\u624b\u52a8\u786e\u8ba4\n    );\n  } catch (error) {\n    console.error("\u8ba2\u9605\u4e3b\u9898\u5931\u8d25:", error);\n    // \u8ba2\u9605\u5931\u8d25\u65f6\u4ece\u5217\u8868\u4e2d\u79fb\u9664\n    subscribedTopics = subscribedTopics.filter(item => item !== transformedTopic);\n  }\n};\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u53d1\u9001\u6d88\u606f",children:"\u53d1\u9001\u6d88\u606f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'// \u53d1\u9001\u6d88\u606f\u5230\u670d\u52a1\u5668\nexport const stompSendMessage = (message: string) => {\n  console.log("STOMP\u53d1\u9001\u6d88\u606f:", transformedTopic, message);\n  \n  // \u68c0\u67e5\u8fde\u63a5\u72b6\u6001\n  if (!stompIsConnected()) {\n    // \u8fde\u63a5\u65ad\u5f00\u65f6\u4f7f\u7528HTTP\u53d1\u9001\n    sendHttpMessage(message);\n    console.log("STOMP\u8fde\u63a5\u65ad\u5f00\uff0c\u4f7f\u7528HTTP\u53d1\u9001");\n    return;\n  }\n  \n  // \u901a\u8fc7STOMP\u53d1\u9001\u6d88\u606f\n  stompClient.publish({\n    destination: "/app/" + transformedTopic,\n    body: message,\n    // \u53ef\u4ee5\u6dfb\u52a0\u81ea\u5b9a\u4e49\u5934\u4fe1\u606f\n    // headers: { priority: \'9\' },\n  });\n};\n\n// \u68c0\u67e5\u8fde\u63a5\u72b6\u6001\nexport const stompIsConnected = () => {\n  return stompClient != null && stompClient?.connected;\n};\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u5904\u7406\u63a5\u6536\u6d88\u606f",children:"\u5904\u7406\u63a5\u6536\u6d88\u606f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// \u5904\u7406\u63a5\u6536\u5230\u7684\u6d88\u606f\nconst handleReceivedMessage = (messageObject: MessageResponse, orgUid: string) => {\n  // \u5224\u65ad\u662f\u5426\u4e3a\u81ea\u5df1\u53d1\u9001\u7684\u6d88\u606f\n  if (!isSelfSend(messageObject)) {\n    console.log(\"\u63a5\u6536\u5230\u5176\u4ed6\u4eba\u7684\u6d88\u606f:\", messageObject);\n    \n    // \u6839\u636e\u6d88\u606f\u7c7b\u578b\u8fdb\u884c\u4e0d\u540c\u5904\u7406\n    switch (messageObject.type) {\n      case 'READ':\n      case 'DELIVERED':\n        // \u6d88\u606f\u56de\u6267\u5904\u7406\n        console.log(\"\u6536\u5230\u6d88\u606f\u56de\u6267:\", messageObject);\n        updateMessageStatus(messageObject);\n        return;\n        \n      case 'TYPING':\n        // \u663e\u793a\u6b63\u5728\u8f93\u5165\u72b6\u6001\n        showTypingIndicator();\n        return;\n        \n      case 'PROCESSING':\n        // \u663e\u793a\u5904\u7406\u4e2d\u72b6\u6001\n        showProcessingIndicator();\n        return;\n        \n      case 'RECALL':\n        // \u5904\u7406\u6d88\u606f\u64a4\u56de\n        handleRecallMessage(messageObject);\n        return;\n        \n      case 'TRANSFER':\n      case 'TRANSFER_ACCEPT':\n      case 'TRANSFER_REJECT':\n        // \u5ffd\u7565\u8f6c\u63a5\u76f8\u5173\u6d88\u606f\n        return;\n        \n      case 'INVITE_VISITOR':\n        // \u5904\u7406\u8bbf\u5ba2\u9080\u8bf7\n        handleVisitorInvite(messageObject);\n        break;\n        \n      case 'AUTO_CLOSED':\n        // \u4f1a\u8bdd\u81ea\u52a8\u5173\u95ed\uff0c\u4e0d\u64ad\u653e\u63d0\u793a\u97f3\n        break;\n        \n      default:\n        // \u64ad\u653e\u6d88\u606f\u63d0\u793a\u97f3\n        playAudio();\n    }\n    \n    // \u53d1\u9001\u6d88\u606f\u9001\u8fbe\u56de\u6267\n    sendReceiptMessage(orgUid, messageObject);\n    \n  } else {\n    console.log(\"\u63a5\u6536\u5230\u81ea\u5df1\u53d1\u9001\u7684\u6d88\u606f:\", messageObject);\n    \n    // \u5904\u7406\u81ea\u5df1\u53d1\u9001\u7684\u6d88\u606f\n    switch (messageObject.type) {\n      case 'RATE_SUBMIT':\n        showSuccessMessage(\"\u8bc4\u4ef7\u6210\u529f\");\n        updateMessageStatus(messageObject);\n        return;\n        \n      case 'LEAVE_MSG_SUBMIT':\n        showSuccessMessage(\"\u7559\u8a00\u6210\u529f\");\n        updateMessageStatus(messageObject);\n        return;\n        \n      case 'RECALL':\n        handleRecallMessage(messageObject);\n        return;\n    }\n    \n    // \u6807\u8bb0\u6d88\u606f\u53d1\u9001\u6210\u529f\n    messageObject.status = 'SUCCESS';\n  }\n  \n  // \u5c06\u6d88\u606f\u6dfb\u52a0\u5230\u6d88\u606f\u5217\u8868\n  addMessageToStore(messageObject);\n};\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u7279\u6b8a\u6d88\u606f\u7c7b\u578b\u5904\u7406",children:"\u7279\u6b8a\u6d88\u606f\u7c7b\u578b\u5904\u7406"}),"\n",(0,i.jsx)(e.h4,{id:"1-\u53d1\u9001\u7559\u8a00\u6d88\u606f",children:"1. \u53d1\u9001\u7559\u8a00\u6d88\u606f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'type StompLeaveMsgProps = {\n  uid?: string;\n  nickname?: string;\n  contact?: string;\n  content?: string;\n  type?: string;\n  images?: string[];\n  thread: ThreadResponse;\n  visitor: VisitorProtobuf;\n};\n\nexport const stompSendLeaveMessage = ({\n  uid,\n  nickname,\n  contact,\n  content,\n  type,\n  images,\n  thread,\n  visitor,\n}: StompLeaveMsgProps) => {\n  const messageExtra = {\n    uid: uid || "",\n    nickname: nickname,\n    contact: contact,\n    content: content,\n    type: type,\n    images: images,\n    orgUid: getCurrentOrgUid(),\n  };\n  \n  const message = {\n    uid: uid,\n    type: "LEAVE_MSG_SUBMIT",\n    content: uid,\n    status: "SENDING",\n    createdAt: new Date().toISOString(),\n    channel: "HTTP",\n    extra: JSON.stringify(messageExtra),\n    thread: thread,\n    user: visitor,\n  };\n  \n  const messageJson = JSON.stringify(message);\n  stompSendMessage(messageJson);\n};\n'})}),"\n",(0,i.jsx)(e.h4,{id:"2-\u53d1\u9001\u8bc4\u4ef7\u6d88\u606f",children:"2. \u53d1\u9001\u8bc4\u4ef7\u6d88\u606f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'type StompRateSubmitProps = {\n  uid: string;\n  score: number;\n  resolved: boolean;\n  content?: string;\n  disabled: boolean;\n  type: string;\n  thread: ThreadResponse;\n  visitor: VisitorProtobuf;\n};\n\nexport const stompSendRateSubmitMessage = ({\n  uid,\n  score,\n  resolved,\n  content,\n  thread,\n  visitor,\n}: StompRateSubmitProps) => {\n  const messageExtra = {\n    score: score,\n    resolved: resolved,\n    content: content || "",\n    orgUid: getCurrentOrgUid(),\n  };\n  \n  const message = {\n    uid: generateUUID(),\n    type: "RATE_SUBMIT",\n    content: uid, // \u8bc4\u4ef7\u5bf9\u8c61\u7684\u6d88\u606fID\n    status: "SENDING",\n    createdAt: new Date().toISOString(),\n    channel: "HTTP",\n    extra: JSON.stringify(messageExtra),\n    thread: thread,\n    user: visitor,\n  };\n  \n  const messageJson = JSON.stringify(message);\n  stompSendMessage(messageJson);\n};\n'})}),"\n",(0,i.jsx)(e.h4,{id:"3-\u53d1\u9001\u6d88\u606f\u64a4\u56de",children:"3. \u53d1\u9001\u6d88\u606f\u64a4\u56de"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'export const stompSendRecallMessage = (\n  recallMessageUid: string,\n  thread: ThreadResponse,\n) => {\n  console.log("\u53d1\u9001\u64a4\u56de\u6d88\u606f:", recallMessageUid);\n  \n  const messageExtra = {\n    orgUid: getCurrentOrgUid(),\n  };\n  \n  const message = {\n    uid: generateUUID(),\n    type: "RECALL",\n    content: recallMessageUid, // \u8981\u64a4\u56de\u7684\u6d88\u606fID\n    status: "SENDING",\n    createdAt: new Date().toISOString(),\n    channel: "HTTP",\n    extra: JSON.stringify(messageExtra),\n    thread: thread,\n    user: getCurrentVisitor(),\n  };\n  \n  const messageJson = JSON.stringify(message);\n  stompSendMessage(messageJson);\n};\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u6d88\u606f\u56de\u6267\u5904\u7406",children:"\u6d88\u606f\u56de\u6267\u5904\u7406"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'// \u53d1\u9001\u6d88\u606f\u56de\u6267\nconst sentUIDs = new Set<string>(); // \u907f\u514d\u91cd\u590d\u53d1\u9001\u56de\u6267\n\nexport const sendReceiptMessage = (\n  orgUid: string,\n  message: MessageResponse\n) => {\n  // \u68c0\u67e5\u662f\u5426\u9700\u8981\u53d1\u9001\u56de\u6267\n  if (shouldSendReceipt(message?.type)) {\n    const uid = message?.uid || "";\n    \n    // \u907f\u514d\u91cd\u590d\u53d1\u9001\n    if (!sentUIDs.has(uid)) {\n      sentUIDs.add(uid);\n      \n      const messageExtra = {\n        orgUid: orgUid,\n      };\n      \n      const receiptMessage = {\n        uid: generateUUID(),\n        type: "READ", // \u8bbf\u5ba2\u7aef\u6536\u5230\u5373\u5df2\u8bfb\n        status: "SENDING",\n        content: message?.uid, // \u539f\u6d88\u606fID\n        thread: message?.thread,\n        extra: JSON.stringify(messageExtra),\n        channel: "HTTP",\n        user: {\n          uid: getCurrentVisitor().uid,\n        },\n      };\n      \n      stompSendMessage(JSON.stringify(receiptMessage));\n    }\n  }\n};\n\n// \u6279\u91cf\u53d1\u9001\u6d88\u606f\u56de\u6267\nexport const sendReceiptMessageList = (\n  orgUid: string,\n  messageList: MessageResponse[]\n) => {\n  messageList.forEach((message) => {\n    if (message?.status === "SUCCESS" || message?.status === "SENDING") {\n      sendReceiptMessage(orgUid, message);\n    }\n  });\n};\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u8fde\u63a5\u7ba1\u7406",children:"\u8fde\u63a5\u7ba1\u7406"}),"\n",(0,i.jsx)(e.h3,{id:"\u53d6\u6d88\u8ba2\u9605",children:"\u53d6\u6d88\u8ba2\u9605"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'export const stompUnsubscribe = (topic: string) => {\n  console.log("\u53d6\u6d88\u8ba2\u9605\u4e3b\u9898:", topic);\n  \n  if (stompClient == null) {\n    console.log("STOMP\u5ba2\u6237\u7aef\u4e0d\u5b58\u5728");\n    return;\n  }\n  \n  stompClient.unsubscribe(topic);\n  subscribedTopics = subscribedTopics.filter(item => item !== topic);\n};\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u65ad\u5f00\u8fde\u63a5",children:"\u65ad\u5f00\u8fde\u63a5"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'export const stompDisconnect = () => {\n  console.log("\u65ad\u5f00STOMP\u8fde\u63a5");\n  \n  if (stompClient == null) {\n    return;\n  }\n  \n  stompClient.deactivate();\n  subscribedTopics = [];\n};\n'})}),"\n",(0,i.jsx)(e.h3,{id:"http\u964d\u7ea7\u5904\u7406",children:"HTTP\u964d\u7ea7\u5904\u7406"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'// \u5f53STOMP\u8fde\u63a5\u65ad\u5f00\u65f6\uff0c\u4f7f\u7528HTTP\u53d1\u9001\u6d88\u606f\nexport const sendHttpMessage = async (message: string) => {\n  try {\n    const response = await sendRestMessage(message);\n    console.log("HTTP\u53d1\u9001\u6d88\u606f:", message, response.data);\n    \n    if (response.data.code === 200) {\n      const messageObject = JSON.parse(message);\n      \n      // \u66f4\u65b0\u6d88\u606f\u72b6\u6001\u4e3a\u6210\u529f\n      messageObject.status = "SUCCESS";\n      updateMessageStatus(messageObject);\n      \n      // \u663e\u793a\u6210\u529f\u63d0\u793a\n      if (messageObject?.type === "RATE_SUBMIT") {\n        showSuccessMessage("\u8bc4\u4ef7\u6210\u529f");\n      }\n      if (messageObject?.type === "LEAVE_MSG_SUBMIT") {\n        showSuccessMessage("\u7559\u8a00\u6210\u529f");\n      }\n    } else {\n      showErrorMessage(response.data.message);\n    }\n  } catch (error) {\n    console.error("HTTP\u53d1\u9001\u6d88\u606f\u5931\u8d25:", error);\n    showErrorMessage("\u6d88\u606f\u53d1\u9001\u5931\u8d25");\n  }\n};\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,i.jsx)(e.h3,{id:"1-\u8fde\u63a5\u7ba1\u7406",children:"1. \u8fde\u63a5\u7ba1\u7406"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5ef6\u65f6\u8ba2\u9605"}),"\uff1a\u8fde\u63a5\u6210\u529f\u540e\u5ef6\u65f6500ms\u518d\u8ba2\u9605\uff0c\u786e\u4fdd\u8fde\u63a5\u7a33\u5b9a"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u9632\u91cd\u590d\u8ba2\u9605"}),"\uff1a\u4f7f\u7528\u8ba2\u9605\u5217\u8868\u907f\u514d\u91cd\u590d\u8ba2\u9605\u76f8\u540c\u4e3b\u9898"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u81ea\u52a8\u91cd\u8fde"}),"\uff1a\u5229\u7528STOMP\u5ba2\u6237\u7aef\u7684\u81ea\u52a8\u91cd\u8fde\u673a\u5236"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u72b6\u6001\u68c0\u67e5"}),"\uff1a\u53d1\u9001\u6d88\u606f\u524d\u68c0\u67e5\u8fde\u63a5\u72b6\u6001"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"2-\u6d88\u606f\u5904\u7406",children:"2. \u6d88\u606f\u5904\u7406"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u56de\u6267\u53bb\u91cd"}),"\uff1a\u4f7f\u7528Set\u5b58\u50a8\u5df2\u53d1\u9001\u56de\u6267\u7684\u6d88\u606fID\uff0c\u907f\u514d\u91cd\u590d\u53d1\u9001"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6d88\u606f\u786e\u8ba4"}),"\uff1a\u4f7f\u7528\u5ba2\u6237\u7aef\u624b\u52a8\u786e\u8ba4\u6a21\u5f0f\uff0c\u786e\u4fdd\u6d88\u606f\u5904\u7406\u5b8c\u6210"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u9519\u8bef\u5904\u7406"}),"\uff1a\u8ba2\u9605\u5931\u8d25\u65f6\u53ca\u65f6\u6e05\u7406\u8ba2\u9605\u5217\u8868"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u964d\u7ea7\u673a\u5236"}),"\uff1a\u8fde\u63a5\u65ad\u5f00\u65f6\u81ea\u52a8\u5207\u6362\u5230HTTP\u53d1\u9001"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"3-\u6027\u80fd\u4f18\u5316",children:"3. \u6027\u80fd\u4f18\u5316"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5fc3\u8df3\u914d\u7f6e"}),"\uff1a\u5408\u7406\u8bbe\u7f6e\u5fc3\u8df3\u95f4\u9694\uff0c\u4fdd\u6301\u8fde\u63a5\u6d3b\u8dc3"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6d88\u606f\u7f13\u5b58"}),"\uff1a\u907f\u514d\u91cd\u590d\u5904\u7406\u76f8\u540c\u6d88\u606f"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u8d44\u6e90\u6e05\u7406"}),"\uff1a\u65ad\u5f00\u8fde\u63a5\u65f6\u53ca\u65f6\u6e05\u7406\u8ba2\u9605\u548c\u7f13\u5b58"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"4-\u7528\u6237\u4f53\u9a8c",children:"4. \u7528\u6237\u4f53\u9a8c"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5b9e\u65f6\u53cd\u9988"}),"\uff1a\u53ca\u65f6\u663e\u793a\u6d88\u606f\u72b6\u6001\u548c\u5904\u7406\u7ed3\u679c"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u58f0\u97f3\u63d0\u793a"}),"\uff1a\u65b0\u6d88\u606f\u5230\u8fbe\u65f6\u64ad\u653e\u63d0\u793a\u97f3"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u72b6\u6001\u6307\u793a"}),"\uff1a\u663e\u793a\u5bf9\u65b9\u6b63\u5728\u8f93\u5165\u3001\u5904\u7406\u4e2d\u7b49\u72b6\u6001"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u5b8c\u6574\u793a\u4f8b",children:"\u5b8c\u6574\u793a\u4f8b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'import * as StompJs from "@stomp/stompjs";\n\n// \u5b8c\u6574\u7684STOMP\u8fde\u63a5\u548c\u4f7f\u7528\u793a\u4f8b\nclass StompManager {\n  private stompClient: StompJs.Client | null = null;\n  private subscribedTopics: string[] = [];\n  private currentTopic: string = "";\n\n  // \u5efa\u7acb\u8fde\u63a5\n  async connect(username: string, topic: string, orgUid: string) {\n    this.subscribedTopics = [];\n    \n    this.stompClient = new StompJs.Client({\n      brokerURL: this.getStompWsUrl(),\n      connectHeaders: {\n        login: username || "",\n      },\n      heartbeatIncoming: 10 * 1000,\n      heartbeatOutgoing: 10 * 1000,\n      debug: (str) => {\n        if (process.env.NODE_ENV === \'development\') {\n          console.log("STOMP:", str);\n        }\n      },\n    });\n\n    // \u8bbe\u7f6e\u4e8b\u4ef6\u76d1\u542c\n    this.setupEventHandlers(topic, orgUid);\n    \n    // \u6fc0\u6d3b\u8fde\u63a5\n    this.stompClient.activate();\n  }\n\n  // \u8bbe\u7f6e\u4e8b\u4ef6\u5904\u7406\n  private setupEventHandlers(topic: string, orgUid: string) {\n    if (!this.stompClient) return;\n\n    this.stompClient.onConnect = (frame) => {\n      console.log("\u8fde\u63a5\u6210\u529f:", frame);\n      setTimeout(() => {\n        this.subscribe(topic, orgUid);\n      }, 500);\n    };\n\n    this.stompClient.onDisconnect = (frame) => {\n      console.log("\u8fde\u63a5\u65ad\u5f00:", frame);\n      this.subscribedTopics = [];\n    };\n\n    this.stompClient.onStompError = (frame) => {\n      console.error("STOMP\u9519\u8bef:", frame.headers["message"]);\n      this.subscribedTopics = [];\n    };\n  }\n\n  // \u8ba2\u9605\u6d88\u606f\n  private subscribe(topic: string, orgUid: string) {\n    if (!this.stompClient?.connected) return;\n\n    const transformedTopic = topic.replace(/\\//g, ".");\n    \n    if (this.subscribedTopics.includes(transformedTopic)) return;\n    \n    this.subscribedTopics.push(transformedTopic);\n    this.currentTopic = transformedTopic;\n\n    this.stompClient.subscribe(\n      `/topic/${transformedTopic}`,\n      (message) => {\n        if (message.body) {\n          const messageObject = JSON.parse(message.body);\n          this.handleMessage(messageObject, orgUid);\n        }\n        message.ack();\n      },\n      { ack: "client" }\n    );\n  }\n\n  // \u53d1\u9001\u6d88\u606f\n  sendMessage(message: string) {\n    if (!this.isConnected()) {\n      this.sendHttpMessage(message);\n      return;\n    }\n\n    this.stompClient!.publish({\n      destination: `/app/${this.currentTopic}`,\n      body: message,\n    });\n  }\n\n  // \u68c0\u67e5\u8fde\u63a5\u72b6\u6001\n  isConnected(): boolean {\n    return this.stompClient != null && this.stompClient.connected;\n  }\n\n  // \u65ad\u5f00\u8fde\u63a5\n  disconnect() {\n    if (this.stompClient) {\n      this.stompClient.deactivate();\n      this.subscribedTopics = [];\n    }\n  }\n\n  private getStompWsUrl(): string {\n    return process.env.NODE_ENV === \'development\' \n      ? "ws://127.0.0.1:9003/stomp"\n      : "wss://api.weiyuai.cn/stomp";\n  }\n\n  private handleMessage(messageObject: any, orgUid: string) {\n    // \u6d88\u606f\u5904\u7406\u903b\u8f91\n    console.log("\u5904\u7406\u6d88\u606f:", messageObject);\n  }\n\n  private async sendHttpMessage(message: string) {\n    // HTTP\u964d\u7ea7\u53d1\u9001\u903b\u8f91\n    console.log("HTTP\u53d1\u9001:", message);\n  }\n}\n\n// \u4f7f\u7528\u793a\u4f8b\nconst stompManager = new StompManager();\n\n// \u5efa\u7acb\u8fde\u63a5\nstompManager.connect("visitor123", "org.123.visitor.456", "org123");\n\n// \u53d1\u9001\u6d88\u606f\nsetTimeout(() => {\n  const message = {\n    uid: "msg123",\n    type: "TEXT",\n    content: "Hello World!",\n    status: "SENDING",\n    createdAt: new Date().toISOString(),\n  };\n  \n  stompManager.sendMessage(JSON.stringify(message));\n}, 2000);\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u53c2\u8003\u8fde\u63a5",children:"\u53c2\u8003\u8fde\u63a5"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://stomp-js.github.io/guide/stompjs/using-stompjs-v5.html",children:"STOMP.js \u5b98\u65b9\u6587\u6863"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://stomp.github.io/stomp-specification-1.2.html",children:"STOMP\u534f\u8bae\u89c4\u8303"})}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}}}]);